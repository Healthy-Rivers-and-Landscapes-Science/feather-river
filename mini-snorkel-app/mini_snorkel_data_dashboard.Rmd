---
title: "Feather Mini Snorkel Cover Data Visualization"
output: 
  flexdashboard::flex_dashboard:
    theme: readable
  font_family: "Roboto"
  google_fonts: true
runtime: shiny
---

```{r global, include=FALSE}
library(tidyverse)
library(leaflet)

colors_full <-  c("#9A8822", "#F5CDB4", "#F8AFA8", "#FDDDA0", "#74A089", #Royal 2
                  "#899DA4", "#C93312", "#DC863B", # royal 1 (- 3)
                  "#F1BB7B", "#FD6467", "#5B1A18", "#D67236",# Grand Budapest 1 (-4)
                  "#D8B70A", "#02401B", "#A2A475", # Cavalcanti 1
                  "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", #Grand Budapest 2
                  "#9986A5", "#EAD3BF", "#AA9486", "#B6854D", "#798E87", # Isle of dogs 2 altered slightly
                  "#F3DF6C", "#CEAB07", "#D5D5D3", "#24281A", # Moonriese 1, 
                  "#798E87", "#C27D38", "#CCC591", "#29211F", # moonrise 2
                  "#85D4E3", "#F4B5BD", "#9C964A", "#CDC08C", "#FAD77B" ) # moonrise 3 

source(here::here("mini-snorkel-app","pull_from_edi.R"))

feather_cover <- mini_fish_raw |> 
  left_join(mini_locations_raw |> 
              distinct(location_table_id, date, channel_location)) |> 
  mutate(woody_debris = percent_small_woody_cover_inchannel + percent_large_woody_cover_inchannel,
         boulder = percent_boulder_substrate,
         cobble = percent_cobble_substrate, 
         undercut_bank = percent_undercut_bank, 
         aquatic_veg = percent_submerged_aquatic_veg_inchannel, 
         overhanging_veg = percent_cover_half_meter_overhead + percent_cover_more_than_half_meter_overhead) |> 
  select(micro_hab_data_tbl_id, location_table_id, transect_code,
         woody_debris:overhanging_veg) |>
  pivot_longer(cols = c(woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg), names_to = "cover_type", 
               values_to = "percent_cover") |>  
  distinct() 


locations_sf <- sf::st_as_sf(mini_locations_raw |> na.omit(), coords = c('longitude', 'latitude')) |> 
  select(location_table_id, location) |> 
  distinct() |> 
  mutate(color = colors_full[match(location, location)])


```

## Column {data-width="500"}

------------------------------------------------------------------------

```{r}
selectInput("location_filter", label = "Filter by Location:",
            choices = c(unique(locations_sf$location)), selected = "hatchery ditch")

# TODO: figure out best way to integrate this component 
# selectInput("channel_type_filter", label = "Filter by Channel Type:",
#             choices = c("LFC", "HFC"))

```

```{r}
filtered_location_id <- reactive({
  locations_sf |>
    filter(location == input$location_filter) |>
    pull(location_table_id) |> 
    unique()
})
```

```{r}
output$location_id_ui <- renderUI({
  selectInput("location_id", label = "Filter by Location Table Id:",
              choices = c(filtered_location_id()))
})
```


```{r}

uiOutput("location_id_ui")
```

***



```{r}
renderPlot({
  ggplot(feather_cover |> filter(location_table_id == input$location_id),
         aes(y = cover_type, x = as.factor(micro_hab_data_tbl_id), fill = percent_cover)) + 
    geom_tile() + 
    scale_fill_viridis_c(name = "percent cover") +
    labs(
      x = "Micro Habitat Data Table ID",   
      y = "Cover Type"                     
    ) +
    theme(
      axis.title = element_text(size = 16),
      axis.text = element_text(size = 10, face = "bold"),
      legend.title = element_text(size = 14, face = "bold"),
      legend.text = element_text(size = 10, face = "bold")
    )
})
```

## Column {data-width="490"}

### Habitat Map

Each circle represents a unique habitat location. Each location has multiple `location_ids` and each `location_id` represents an array of microhabitat grids that were sampled for cover. 

```{r}
leaflet(locations_sf) |> 
  addProviderTiles(providers$Esri.WorldImagery, group = "Aerial Imagery") |> 
  addProviderTiles(providers$OpenStreetMap, group = "Street Map") |> 
  addCircleMarkers(color = ~color,
                   radius = 6,
                   fill = TRUE, 
                   fillOpacity = 0.2,
                   opacity = 0.6,
                   popup = paste0("Location Name: ", locations_sf$location, 
                                  "<br>",
                                  "Location ID: ", locations_sf$location_table_id)) |> 
  addLayersControl(
    baseGroups = c("Aerial Imagery", "Street Map"),
    options = layersControlOptions(collapsed = FALSE)
  )
# addLegend("bottomright", 
#           colors = locations_sf$color, 
#           labels = locations_sf$location,
#           title = "Location Names", opacity = 1)

```

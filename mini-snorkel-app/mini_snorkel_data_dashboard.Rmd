---
title: "Feather Mini Snorkel Cover Data Visualization"
output: 
  flexdashboard::flex_dashboard:
    theme: readable
  font_family: "Roboto"
  google_fonts: true
runtime: shiny
---

```{r global, include=FALSE}
library(tidyverse)
library(leaflet)

colors_full <-  c("#9A8822", "#F5CDB4", "#F8AFA8", "#FDDDA0", "#74A089", #Royal 2
                  "#899DA4", "#C93312", "#DC863B", # royal 1 (- 3)
                  "#F1BB7B", "#FD6467", "#5B1A18", "#D67236",# Grand Budapest 1 (-4)
                  "#D8B70A", "#02401B", "#A2A475", # Cavalcanti 1
                  "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", #Grand Budapest 2
                  "#9986A5", "#EAD3BF", "#AA9486", "#B6854D", "#798E87", # Isle of dogs 2 altered slightly
                  "#F3DF6C", "#CEAB07", "#D5D5D3", "#24281A", # Moonriese 1, 
                  "#798E87", "#C27D38", "#CCC591", "#29211F", # moonrise 2
                  "#85D4E3", "#F4B5BD", "#9C964A", "#CDC08C", "#FAD77B" ) # moonrise 3 

 fish_pres_cols <- c('Yes' = "#E6A0C4", 'No' = "#D5D5D3")

colfunc <- colorRampPalette(c("#02401B", "white"))
gradient <- colfunc(100)

mini_locations_raw <- read_csv(here::here("mini-snorkel-app", "mini_locations_raw.csv"))
mini_fish_raw <- read_csv(here::here("mini-snorkel-app", "mini_fish_raw.csv"))
# orders locations from upstream to downstream. 
# TODO we are missing coordinates for some locations
location_order <- tibble(location = c("hatchery ditch", "hour bars", "hatchery riffle", "trailer park", 
                                      "bedrock riffle", "steep riffle", "robinson riffle", "upper big hole", 
                                      "lower big hole", "g95", "gridley riffle", "big bar", "goose riffle", 
                                      "macfarland riffle", "shallow riffle", "herringer riffle", "junkyard riffle", 
                                      "auditorium riffle", "eye side channel", "matthews riffle", "eye riffle", 
                                      "lower hour", "aleck riffle", "weir riffle", "vance avenue", 
                                      "big hole", "hour riffle", "cox riffle", "gateway riffle"),
                         order = c(2,19,1,5,
                                   4,9,8,15,
                                   16,17,23,21,20,
                                   22,25,26,24,
                                   3,11,6,12,
                                   18,7,10,13,
                                   14,NA,NA,NA))

feather_cover <- mini_fish_raw |> 
  left_join(mini_locations_raw |> 
              distinct(location_table_id, date, channel_location, location)) |> 
  # create cover variables that are more consistent with strategic plan categories
  mutate(woody_debris = percent_small_woody_cover_inchannel + percent_large_woody_cover_inchannel,
         boulder = percent_boulder_substrate,
         cobble = percent_cobble_substrate, 
         undercut_bank = percent_undercut_bank, 
         aquatic_veg = percent_submerged_aquatic_veg_inchannel, 
         overhanging_veg = percent_cover_half_meter_overhead + percent_cover_more_than_half_meter_overhead) |> 
  select(micro_hab_data_tbl_id, location_table_id, transect_code, location,
         woody_debris:overhanging_veg, count) |>
  pivot_longer(cols = c(woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg), names_to = "cover_type", 
               values_to = "percent_cover") |>  
  distinct() |> 
  left_join(location_order) |> 
  mutate(fish_presence = ifelse(count > 0, "Yes", "No")) |> select(-count)

summary_cover <- feather_cover |> 
  group_by(location, cover_type, order, fish_presence) |> 
  summarize(percent_cover = mean(percent_cover)) |> 
  mutate(percent_cover = ifelse(is.na(percent_cover), 0, percent_cover))

# added distinct statement because there seem to be duplicates in the location table (we should fix this on EDI)

# TODO - The color setting isn't quite working
locations_sf <- sf::st_as_sf(mini_locations_raw |> 
                               distinct(location_table_id, date, channel_location, .keep_all = T) |> 
                               na.omit(), coords = c('longitude', 'latitude')) |> 
  select(location_table_id, location, channel_type) |> 
  mutate(color = colors_full[match(location, location)]) 
# group_by(geometry, location, channel_type, color) |> 
# summarise(location_table_id = paste0(unique(location_table_id), collapse = "; ")) |> glimpse()

```

```{r}
filtered_location_id <- reactiveValues(
  selected_points = NULL,
  filtered_data = feather_cover
)
```

Habitat Summary
========================================================================

Column
------------------------------------------------------------------------

### Feather River locations are ordered from most upstream (closed to Oroville Dam) to the most downstream. Percent cover is averaged across all microhabitat plots within each location. See the Map Filter or Attribute Filter for more detailed summaries of habitat by microhabitat.

```{r, fig.width=11}
summary_cover |> 
  filter(!is.na(order)) |> 
  group_by(cover_type) |> 
  arrange(desc(order)) |> 
  mutate(location = factor(location, levels=unique(location), ordered = T)) |> 
  ggplot(aes(x = cover_type, y = location, fill = percent_cover)) + 
  #scale_y_reverse() +
  geom_tile(color = "white") + 
  scale_fill_gradient(low = "#D5D5D3", high = "#02401B", name = "Mean Percent Cover") +
  labs(
    x = "",   
    y = ""                     
  ) +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 10, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "bold"),
    legend.position = "top"
  )
```



Map Filter
========================================================================

Column
------------------------------------------------------------------------

### Habitat Map

Each circle represents a unique habitat location. Each location may have multiple `location_ids` and each `location_id` represents an array of microhabitat grids that were sampled for cover. Note that there are duplicate coordinates for some `location_ids`.

```{r}
output$mapfilter <- renderLeaflet({
  leaflet(locations_sf) |> 
    addProviderTiles(providers$Esri.WorldImagery, group = "Aerial Imagery") |> 
    addProviderTiles(providers$OpenStreetMap, group = "Street Map") |> 
    addCircleMarkers(layerId = ~location_table_id,
                     color = ~color,
                     radius = 6,
                     fill = TRUE,
                     fillOpacity = 0.2,
                     opacity = 0.6,
                     popup = paste0("Location Name: ", locations_sf$location, 
                                    "<br>",
                                    "Location ID: ", locations_sf$location_table_id,
                                    "<br>",
                                    "Channel Type: ", locations_sf$channel_type)) |> 
    addLayersControl(
      baseGroups = c("Aerial Imagery", "Street Map"),
      options = layersControlOptions(collapsed = FALSE)
    )
})

leafletOutput("mapfilter")

```

Column
------------------------------------------------------------------------

### Heat Map

```{r}
click_marker <- eventReactive(input$mapfilter_marker_click, {
  
  click <- input$mapfilter_marker_click
  
  return(click$id)
  
})

filtered_data <- reactive({
  
  return(feather_cover |> 
           filter(location_table_id %in% click_marker()) |> 
           mutate(transect_code = as.factor(transect_code)) |> 
           group_by(transect_code, cover_type, fish_presence, location_table_id) |> 
           summarize(percent_cover = if(all(is.na(percent_cover))) NA_real_ else(mean(percent_cover, na.rm = T))))
  
})

renderPlot({
  
  if (is.null(input$mapfilter_marker_click)) {
    ggplot() +
      annotate("text", x = 0.5, y = 0.5, label = "Click on a Sampling Location\nin Map View to Populate Plot", 
               size = 6, hjust = 0.5, vjust = 0.5) +
      theme_void() +
      theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
      )
  } else {
    
    ggplot(filtered_data(),
           aes(y = transect_code, x = cover_type, fill = percent_cover)) + 
      geom_tile(aes(color = as.character(fish_presence)), size = 1) + 
      scale_color_manual(values = fish_pres_cols, name = "Fish Presence") +
      scale_fill_gradient(low = "#D5D5D3", high = "#02401B", name = "Percent Cover") +
      labs(
        x = "",   
        y = "Microhabitat Unit"                     
      ) +
      theme_minimal() +
      theme(
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(angle = 30),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 10, face = "bold"),
        legend.position = "top"
      )
  }
})
```

Attribute Filter {data-orientation=rows}
========================================================================

Row {data-height=100}
------------------------------------------------------------------------

```{r}
selectInput("location_filter", label = "Filter by Location:",
            choices = c("all locations", unique(locations_sf$location)), selected = "all locations")
# TODO: figure out best way to integrate this component 
# selectInput("channel_type_filter", label = "Filter by Channel Type:",
#             choices = c("LFC", "HFC"))
```

```{r}
filtered_location_id <- reactive({
  locations_sf |>
    filter(location == input$location_filter) |>
    pull(location_table_id) |> 
    unique()
})
```

```{r}
output$location_id_ui <- renderUI({
  selectInput("location_id", label = "Filter by Location Table Id:",
              choices = c("", filtered_location_id()), selected = "-")
})
```

```{r}
uiOutput("location_id_ui")
```

Row
------------------------------------------------------------------------

### Habitat Map

Each circle represents a unique habitat location. Each location has multiple `location_ids` and each `location_id` represents an array of microhabitat grids that were sampled for cover. Note that there are duplicate coordinates for some `location_ids`.

```{r}
output$map <- renderLeaflet({
  leaflet(locations_sf) |> 
    addProviderTiles(providers$Esri.WorldImagery, group = "Aerial Imagery") |> 
    addProviderTiles(providers$OpenStreetMap, group = "Street Map") |> 
    addCircleMarkers(color = ~color,
                     radius = 6,
                     fill = TRUE, 
                     fillOpacity = 0.2,
                     opacity = 0.6,
                     popup = paste0("Location Name: ", locations_sf$location, 
                                    "<br>",
                                    "Location ID: ", locations_sf$location_table_id,
                                    "<br>",
                                    "Channel Type: ", locations_sf$channel_type)) |> 
    addLayersControl(
      baseGroups = c("Aerial Imagery", "Street Map"),
      options = layersControlOptions(collapsed = FALSE)
    ) 
})

leafletOutput("map")

observeEvent(c(input$location_filter, input$location_id), {
  
  req(input$location_filter, input$location_id) 
  
  print(input$location_filter)
  print(input$location_id)
  
  if (input$location_filter != "all locations" && input$location_id != "" && input$location_id != "-") {
    
    selected_location <- locations_sf |> 
      filter(location == input$location_filter) |> 
      group_by(geometry, location, channel_type, color) |> 
      summarise(location_table_id = paste0(unique(location_table_id), collapse = "; ")) |> 
      ungroup() |> 
      filter(str_detect(location_table_id, paste0("\\b", input$location_id, "\\b")))
    
    if (nrow(selected_location) > 0) {
      
      coords <- sf::st_coordinates(selected_location)
      
      leafletProxy("map") |> 
        setView(
          lng = coords[1],  
          lat = coords[2],  
          zoom = 15         
        ) |> 
        clearGroup("highlighted") |>  
        addCircleMarkers(
          data = selected_location,
          lng = coords[1],
          lat = coords[2],
          fillOpacity = 0.2,
          opacity = 0.6,     
          fill = TRUE,
          radius = 6,
          stroke = TRUE,  
          weight = 4,      
          popup = paste0("Location Name: ", selected_location$location, 
                         "<br>",
                         "Location ID: ", selected_location$location_table_id,
                         "<br>",
                         "Channel Type: ", selected_location$channel_type),
          group = "highlighted"  
        )
    }
  }
  
})

```

### Heat Map



```{r}
# c(input$location_filter, input$location_id)



renderPlot({
  if (input$location_filter != "all locations" && input$location_id != "" && input$location_id != "-") {
    ggplot(feather_cover |> 
             filter(location_table_id  == input$location_id) |> 
             mutate(transect_code = as.factor(transect_code)) |> 
             group_by(transect_code, cover_type, fish_presence, location_table_id) |> 
             summarize(percent_cover = if(all(is.na(percent_cover))) NA_real_ else(mean(percent_cover, na.rm = T))),
           aes(x = cover_type, y = transect_code, fill = percent_cover)) + 
      geom_tile(aes(color = fish_presence), size = 1) + 
      scale_color_manual(values = fish_pres_cols, name = "Fish Presence") +
      scale_fill_gradient(low = "#D5D5D3", high = "#02401B", name = "Percent Cover") +
      labs(
        x = "",   
        y = "Microhabitat Unit"                     
      ) +
      theme_minimal() +
      theme(
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(angle = 30),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 10, face = "bold"),
        legend.position = "top"
      )
  } else {
     ggplot() +
      annotate("text", x = 0.5, y = 0.5, label = "Choose a sampling location name and \nlocation ID to populate map",
               size = 6, hjust = 0.5, vjust = 0.5) +
      theme_void() +
      theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
      )
  }
})
```

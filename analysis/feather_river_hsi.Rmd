---
title: "Feather River Habitat Suitability Index Development"
author: "Maddee Rubenson (FlowWest)"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

library(tidyverse)
```

### Adapted Mark Gard HSI process

adapted from <https://github.com/FlowWest/va-feather-river-analysis/blob/mini-snorkel/analysis/feather_river_mini_snorkel_hsi_analysis_exploration.md>

[Mark Gardâ€™s 1998 paper](https://personales.upv.es/fmcapel/data/Technique%20for%20Adjusting%20Spawning%20Depth%20Habitat%20Utilization%20Curves%20for%20Availability.pdf) identified a method to developing HSC for presence and absence of redds in different substrate classes. I will follow the same methodology using fish presence/absence and total fish count instead of redds and also apply to cover.

1.  Determine number of fish with each substrate-size class

2.  Calculate the proportion of fish with each substrate size class

3.  Calculate the HSC value for each substrate size class by dividing the proportion of fish in each substrate class by the proportion of fish with the most frequent substrate class

To convert from percent to discrete:

-   Cover decision: 20% or greater is considered present, which is consistent with the Strategic Plan (table 27, TODO include citation)

Cover includes (table 28 of the Strategic Plan):

-   small woody debris

-   large woody debris

-   boulder

-   cobble

-   grass/herbaceous - emergent vegetation

-   aquatic vegetation - non-emergent

-   willow and other riparian vegetation

-   undercut bank

-   overhanging vegetation

### Case Study - Feather River Mini Snorkel Data

Data was collected as percent cover for the following cover types. This crosswalk was applied to create consistent cover types across the mini snorkel data.

| Mini Snorkel Data Type                                                          | Applied Data Type                    |
|-----------------------------------------------|------------------------|
| percent large woody debris                                                      | large woody cover                    |
| percent small wood                                                              | small woody cover                    |
| percent boulder substrate                                                       | boulder                              |
| percent cobble substrate                                                        | cobble                               |
| percent undercut bank                                                           | undercut bank                        |
| percent submerged aquatic vegetation inchannel                                  | aquatic vegetation                   |
| percent cover half meter overhead + percent cover more than half meter overhead | overhanging vegetation               |
| NA                                                                              | grass/herbaceous                     |
| NA                                                                              | willow and other riparian vegetation |


```{r message=FALSE, warning=FALSE, include=FALSE}

mark_gard_1998_hsi <- function(data, percent_presence = 20, cols = c()) {
  data_tidy <- data |> 
    select(count, cols) |> 
    mutate(fish_presence = ifelse(count > 0, 1, 0)) |> 
    pivot_longer(cols = cols, names_to = "type", values_to = "percent") |> 
    mutate(presence = ifelse(percent >= percent_presence, 1, 0)) |> 
    filter(presence == 1) |> 
    group_by(type) |>
    summarise(n_fish_presence = sum(as.numeric(fish_presence)),
              n_fish_total = sum(count)) |> 
    mutate(prop_fish_presence = n_fish_presence/sum(n_fish_presence),
           prop_fish_total = n_fish_total/sum(n_fish_total)) |> 
    ungroup()
  
     most_freq_total <- data_tidy |> 
      arrange(desc(prop_fish_total)) |> 
      slice(1) 
 
     most_freq_presence <- data_tidy |> 
      arrange(desc(prop_fish_presence)) |> 
      slice(1) 
  
  
  data_tidy_final <- data_tidy |> 
    mutate(hsi_presence = prop_fish_presence/most_freq_presence$prop_fish_presence)
           #hsc_total = prop_fish_total/most_freq_total$prop_fish_total)
  
  return(data_tidy_final)

}

```

```{r message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}

mini_locations_raw <- read_csv(here::here("mini-snorkel-app", "mini_locations_raw.csv"))
mini_fish_raw <- read_csv(here::here("mini-snorkel-app","mini_fish_raw.csv"))

suppressWarnings({
  feather_cover <- mini_fish_raw |> 
  left_join(mini_locations_raw |> 
              distinct(location_table_id, date, channel_location, location)) |> 
  # create cover variables that are more consistent with strategic plan categories
  mutate(small_woody_debris = percent_small_woody_cover_inchannel,
        large_woody_debris = percent_large_woody_cover_inchannel,
         boulder = percent_boulder_substrate,
         cobble = percent_cobble_substrate, 
         undercut_bank = percent_undercut_bank, 
         aquatic_veg = percent_submerged_aquatic_veg_inchannel, 
         overhanging_veg = percent_cover_half_meter_overhead + percent_cover_more_than_half_meter_overhead) |> 
  select(micro_hab_data_tbl_id, location_table_id, transect_code, location,
         small_woody_debris:overhanging_veg, count, date) |>
  distinct() 
})
```

```{r echo=FALSE}
cols <- c('small_woody_debris', 'large_woody_debris', 'boulder', 'cobble', 'undercut_bank', 'aquatic_veg', 'overhanging_veg')

mark_gard_1998_hsi(data = feather_cover, percent_presence = 20, cols = cols) |> 
  pivot_longer(cols = c(hsi_presence), names_to = "HSI", values_to = "values") |> 
  ggplot() + 
  geom_col(aes(y = values, x = type), position = "dodge") +
  coord_flip() +
  ggtitle('Mark Gard 1998: Cover HSI for all of Feather River') + 
  theme_minimal()


```

#### Exploring uneven distribution of cover types

Goal: Does it make sense to weight cover variables given some are just inherently less common (ie., undercut bank)

```{r echo=FALSE}

feather_cover |> 
    select(count, cols) |> 
   # mutate(fish_presence = ifelse(count > 0, 1, 0)) |> 
    pivot_longer(cols = cols, names_to = "type", values_to = "percent") |> 
    filter(!is.na(percent)) |> 
    mutate(cover_presence = ifelse(percent >= 20, 1, 
                             ifelse(percent < 20 & percent >= 0, 0, NA))) |> 
    group_by(type, cover_presence) |> 
#    filter(percent >= 20) |> 
    tally() |> 
  knitr::kable(caption = "This table shows each cover type and the number of times it is >= to 20%")
    
```

```{r echo=FALSE}

feather_cover |> 
    select(count, cols) |> 
   # mutate(fish_presence = ifelse(count > 0, 1, 0)) |> 
    pivot_longer(cols = cols, names_to = "type", values_to = "percent") |> 
    mutate(presence = ifelse(percent >= 20, 1, 
                             ifelse(percent < 20 & percent > 0, 0, NA))) |> 
    group_by(type, presence) |> 
    filter(percent >= 20) |> 
    tally() |> 
    ungroup() |> 
    mutate(sum_n = sum(n),
           weighting_factor = 1-(n/sum_n)) |> 
  knitr::kable(caption = "This table explores potential weighting factors that could be used to achieve a more balanced weighting of each cover type in the HSI analysis")

```


#### Site Level Analysis

Goal 1) compare how site specific HSIs compare across the high and low flow channel, using hatchery ditch (low flow) and g95 (high flow)

Goal 2) how does HSI compare temporally across a single site?

```{r include=FALSE}
mark_gard_1998_hsi_by_location <- function(data, percent_presence = 20, cols = c(), location_name) {
  data_tidy <- data |> 
    filter(location_name == location) |> 
    select(count, cols) |> 
    mutate(fish_presence = ifelse(count > 0, 1, 0)) |> 
    pivot_longer(cols = cols, names_to = "type", values_to = "percent") |> 
    mutate(presence = ifelse(percent >= percent_presence, 1, 0)) |> 
    filter(presence == 1) |> 
    group_by(type) |>
    summarise(n_fish_presence = sum(as.numeric(fish_presence)),
              n_fish_total = sum(count)) |> 
    mutate(prop_fish_presence = n_fish_presence/sum(n_fish_presence),
           prop_fish_total = n_fish_total/sum(n_fish_total)) |> 
    ungroup()
  
     most_freq_total <- data_tidy |> 
      arrange(desc(prop_fish_total)) |> 
      slice(1) 
 
     most_freq_presence <- data_tidy |> 
      arrange(desc(prop_fish_presence)) |> 
      slice(1) 
  
  
  data_tidy_final <- data_tidy |> 
    mutate(hsi_presence = prop_fish_presence/most_freq_presence$prop_fish_presence)
  
  return(data_tidy_final)

}
```

```{r echo=FALSE}
mark_gard_1998_hsi_by_location(data = feather_cover, percent_presence = 20, cols = cols, location_name = "hatchery ditch") |> 
  mutate(location = "hatchery ditch") |> 
  pivot_longer(cols = c(hsi_presence), names_to = "HSI", values_to = "values") |> 
  bind_rows(mark_gard_1998_hsi_by_location(data = feather_cover, percent_presence = 20, 
                                           cols = cols, location_name = "g95") |> 
              mutate(location = "g95") |> 
              pivot_longer(cols = c(hsi_presence), names_to = "HSI", values_to = "values")) |> 
ggplot() + 
  geom_col(aes(y = values, x = type), position = "dodge") +
  coord_flip() +
  facet_grid(~location) +
  xlab("Cover Types") + 
  ylab("HSI") + 
  theme_minimal()

```

**Decisions**

-   The HSI's were developed for fish presence or absence (1/0) regardless of how many fish were present. This was decided to eliminate potential challenges in counting number of fish present and with the assumption that if a fish was present, the habitat is suitable for other fish to also be present.

**Discussion**

-   Sand has a stronger HSI when looking at number of fish vs. presence/absence

-   Presence/absence results are consistent with logistic regression

-   What is the temporal and spatial scale needed for HSI development?

-   Do we want to weight cover variables to better balance HSI? 

